"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var rxjs=require("rxjs");require("tiny-warning");var React=require("react"),React__default=_interopDefault(React),ajax=require("rxjs/ajax"),axios=_interopDefault(require("axios")),fastEquals=require("fast-equals"),PropTypes=_interopDefault(require("prop-types")),watchers=[];function capitalizeFirstLetter(e){return e.charAt(0).toUpperCase()+e.slice(1)}var callMiniVerse=function(n,e,i,t,o){var s=e.getService(capitalizeFirstLetter(i));s&&t.watch[i].forEach(function(t){var e="watch"+capitalizeFirstLetter(t),r={next:function(e){return o.next(i,t,e)},error:function(e){return o.error(i,t,e)}};if("function"!=typeof s[e])return console.error("Watcher "+e+" does not exist in "+i+" service provider."),null;watchers.push(s[e](n+"-constructor",r))})},unsubscribeMiniverse=function(r,e,n,t){var i=e.getService(capitalizeFirstLetter(n));i&&t.watch[n].forEach(function(e){var t="watch"+capitalizeFirstLetter(e);if("function"!=typeof i[t])return console.error("Tried to unsubscribe "+t+" in a service that does not exists "+n+"."),null;i.unsubscribeByComponent(r+"-constructor")})},createWatchers=function(t,r,n,i){if(n.watch)return Object.keys(n.watch).map(function(e){callMiniVerse(t,r,e,n,i)}),watchers},unsubscribeWatchers=function(t,r,n){n.watch&&Object.keys(n.watch).map(function(e){unsubscribeMiniverse(t,r,e,n)})},propName="@@rxjs-hooks",propNameAuth="@@rxjs-hooks-auth",RunHooks=function(e,t,r){var n=this;this.sub$=null,this.components=[],this.hooks=[],this.name=null,this.locals=null,this.shouldRun=!0,this.willRun=0,this.hasRun=0,this.subscribe=function(e,t,r){void 0===t&&(t=function(){}),void 0===r&&(r=function(){}),n.run(),n.sub$.subscribe(e,t,r)},this.next=function(e){n.sub$.next(e)},this.error=function(e){return n.sub$.error(e)},this.complete=function(){return n.sub$.complete()},this.reset=function(){n.hooks=n.getHooks(n.components,n.name),n.willRun=n.hooks.length,n.shouldRun=0<n.willRun},this.getHooks=function(e,n){return(Array.isArray(e)?e:[e]).filter(function(e){return e}).map(function(e){return{component:e,hooks:e.default?e.default[propName]:e[propName]}}).filter(function(e){var t=e.hooks;return t&&t[n]}).map(function(e){var t=e.component,r=e.hooks[n];if("function"!=typeof r)throw new Error('decorator provideHooks MUST contain "fetch" or "watch" functions');return{hook:r,component:t}})},this.run=function(){if(n.hasRun+=1,!n.shouldRun)return n.next(),void n.complete();if(0!==n.hooks.length){var e=n.hooks.shift();return 0===n.hooks.length?n.runHook(e).subscribe(function(){return n.next()},function(e){return n.error(e)},function(){return n.complete()}):n.runHook(e).subscribe(function(){n.run()},function(e){return n.error(e)})}n.next()},this.runHook=function(e){var t=e.hook,r=e.component;return"function"==typeof n.locals?t(n.locals(r)):t(n.locals)},this.components=t,this.name=e,this.locals=r,this.sub$=new rxjs.ReplaySubject,this.reset()},MiniverseContext=React.createContext({});function _extends(){return(_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function _inheritsLoose(e,t){e.prototype=Object.create(t.prototype),(e.prototype.constructor=e).__proto__=t}function _objectWithoutPropertiesLoose(e,t){if(null==e)return{};var r,n,i={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],0<=t.indexOf(r)||(i[r]=e[r]);return i}var Miniverse=function(){function e(e){var n=this;this.services={},this.concat=rxjs.concat,this.zip=rxjs.zip,this.helpers={},this.eject=function(){var t={};return Object.keys(n.services).forEach(function(e){t[e]=n.services[e].eject()}),n._waitAllDone(t)},this.insert=function(t){var r={};return Object.keys(t).forEach(function(e){n.isService(e)&&(r[e]=n.services[e].insert(t[e]))}),n._waitAllDone(r)},this.getService=function(e){if(void 0===n.services[e])throw Error("Service "+e+" is not registered in services");return n.services[e]},this.setHelpers=function(e){var t=e.client,r=_objectWithoutPropertiesLoose(e,["client"]);n.client=t,n.helpers=r},this.getHelper=function(e){return void 0===n.helpers[e]?(console.error("Helper "+e+" is not registered in helpers"),!1):n.helpers[e]},this.objectMap=function(r,n){return Object.keys(r).reduce(function(e,t){return e[t]=n(r[t]),e},{})},this._waitAllDone=function(e){var r=new rxjs.ReplaySubject,t=Object.keys(e),n=t.length,i={};return 0===n&&r.next({}),t.forEach(function(t){e[t].subscribe(function(e){i[t]=e,(n-=1)<=0&&r.next(i)})}),r},this.services=this.objectMap(e,function(e){return new e(n)})}var t=e.prototype;return t.isService=function(e){return void 0!==this.services[e]},t.getClient=function(){return void 0===this.client&&(this.client=ajax.ajax),this.client},e}(),Store=function(){function e(e){var i=this;this.miniverse=void 0,this.subjects={},this.locations={},this.watch=function(e,t,r){i.unsubscribe(e,t);var n=i.createSubject(e);return i.inMemory(e,t,n.subscribe(r)),n},this.get=function(e,t,r){void 0===t&&(t={}),void 0===r&&(r={});var n=i.createSubject(e);return axios({method:"get",url:e,params:t,headers:r}).then(function(e){n.next(e.data)}).catch(function(e){n.error(e)}),n},this.miniverse=e}var t=e.prototype;return t.eject=function(){return this.miniverse._waitAllDone(this.subjects)},t.insert=function(t){var r=this;return Object.keys(t).forEach(function(e){r.createSubject(e).next(t[e])}),this.miniverse._waitAllDone(this.subjects)},t.createSubject=function(e){return this.subjects[e]||(this.subjects[e]=new rxjs.ReplaySubject),this.subjects[e]},t.unsubscribe=function(e,t){this.locations[e]&&this.locations[e][t]&&(this.locations[e][t].unsubscribe(),delete this.locations[e][t])},t.unsubscribeByComponent=function(t){var r=this;Object.keys(this.locations).forEach(function(e){void 0!==r.locations[e]&&void 0!==r.locations[e][t]&&(r.locations[e][t].unsubscribe(),delete r.locations[e][t])})},t.inMemory=function(e,t,r){void 0===this.locations[e]&&(this.locations[e]={}),this.locations[e][t]=r},t.getLocations=function(){return this.locations},t.reset=function(e,t){void 0===t&&(t=null);var r=this.createSubject(e);return r.next(t),r},e}(),provideHooks=function(r){return function(e){if("undefined"!==r.authorized){var t={};t.authorized=r.authorized,e[propNameAuth]=t,delete r.authorized}return 0<Object.keys(r).length&&(e[propName]=r),e}},withMiniverse=function(c){return void 0===c&&(c=null),function(s){if(!c)return function(t){return React__default.createElement(MiniverseContext.Consumer,null,function(e){return React__default.createElement(s,_extends({},t,e))})};var r=function(o){function e(e,t){var i;(i=o.call(this,e,t)||this).state={},i.cache={},i.deepLocation=null,i.provider=null,i.mounted=!1,i.updateState=function(e,t,r){var n=JSON.parse(JSON.stringify(i.state));if(void 0===n[e]&&(n[e]={}),void 0===n[e][t]&&(n[e][t]={}),n[e][t]=JSON.parse(JSON.stringify(r)),!fastEquals.deepEqual(i.state,n))return i.mounted&&i.setState(n),n};var r=e.serviceProvider;i.provider=r,i.deepLocation=c.name||s.displayName||s.name||s.constructor.name;var n={next:function(e,t,r){i.state=i.updateState(e,t,r)},error:function(e,t,r){i.updateState(e,t,r)}};return createWatchers(i.deepLocation,i.provider,c,n),i}_inheritsLoose(e,o);var t=e.prototype;return t.componentWillUnmount=function(){unsubscribeWatchers(this.deepLocation,this.provider,c)},t.render=function(){this.mounted=!0;var e=Object.assign({},_extends({},this.cache),_extends({},this.state));return React__default.createElement(s,_extends({},this.props,e,this.context))},e}(React__default.PureComponent);return r.propTypes={serviceProvider:PropTypes.objectOf(PropTypes.any).isRequired},function(t){return React__default.createElement(MiniverseContext.Consumer,null,function(e){return React__default.createElement(r,_extends({},t,e))})}}};exports.createWatchers=createWatchers,exports.unsubscribeWatchers=unsubscribeWatchers,exports.propName=propName,exports.propNameAuth=propNameAuth,exports.runHooks=RunHooks,exports.MiniverseContext=MiniverseContext,exports.Miniverse=Miniverse,exports.Store=Store,exports.provideHooks=provideHooks,exports.withMiniverse=withMiniverse;
